version: '3.8'

services:
  # Redis for Map Service
  redis-map:
    image: redis:7-alpine
    container_name: tabelogo-redis-map-dev
    ports:
      - "6380:6379"
    volumes:
      - redis-map-data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - tabelogo-network

  # Map Service
  map-service:
    build:
      context: ../..
      dockerfile: cmd/map-service/Dockerfile
    container_name: tabelogo-map-service
    env_file:
      - ../../cmd/map-service/.env.example
    environment:
      REDIS_HOST: redis-map
      REDIS_PORT: 6379
      REDIS_DB: 5
      PORT: 8081
    ports:
      - "8081:8081"
    depends_on:
      redis-map:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - tabelogo-network

volumes:
  redis-map-data:
    driver: local

networks:
  tabelogo-network:
    driver: bridge
